- hosts: "{{ psc_servers }}"

  tasks:
  - name: Checking PSC replica
    become: yes
    shell: /usr/lib/vmware-vmdir/bin/vdcrepadmin -f showpartnerstatus -h localhost -u administrator -w {{ psc_pass }}
    register: replica_status

  - name: debug
    debug:
      msg: "{{ item.split(':')[0] }} -- {{ item.split(':')[1] }}"
    loop: "{{ replica_status.stdout_lines }}"
    ignore_errors: yes

  - name: Send message when supervisor process is not running
    slack:
      token: T9N25BYMC/BEJ5TU0MP/UkjPmJsB7d1D0BAA2Belyjxf
      msg: "{{ ansible_hostname }} {{ item.split(':')[0] }} is not available"
    loop: "{{ replica_status.stdout_lines }}"
    when: ("{{ item.split(':')[1] }}" == 'Yes')
    delegate_to: localhost
    ignore_errors: yes
